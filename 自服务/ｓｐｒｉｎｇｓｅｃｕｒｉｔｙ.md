

# OAuth

ä¸€ä¸ªæˆæƒæœºåˆ¶ï¼Œæ•°æ®çš„æ‰€æœ‰è€…å‘Šè¯‰ç³»ç»Ÿï¼ŒåŒæ„æˆæƒç¬¬ä¸‰æ–¹åº”ç”¨è¿›å…¥ç³»ç»Ÿï¼Œè·å–æŸäº›æ•°æ®ï¼Œç³»ç»Ÿäº§ç”Ÿä¸€ä¸ªçŸ­æœŸçš„è¿›å…¥ä»¤ç‰ŒTokenï¼Œç”¨æ¥ä»£æ›¿ç¬¬ä¸‰æ–¹åº”ç”¨ä½¿ç”¨ã€‚

https://juejin.cn/post/6844903833882066958 

 ![img](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/4/30/16a6db27ba5a97fe~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp) 

ä»¤ç‰Œï¼ˆtokenï¼‰ä¸å¯†ç ï¼ˆpasswordï¼‰çš„ä½œç”¨æ˜¯ä¸€æ ·çš„ï¼Œéƒ½å¯ä»¥è¿›å…¥ç³»ç»Ÿï¼Œä½†æ˜¯æœ‰ä¸‰ç‚¹å·®å¼‚ã€‚

1. ä»¤ç‰Œæ˜¯çŸ­æœŸçš„ï¼Œåˆ°æœŸä¼šè‡ªåŠ¨å¤±æ•ˆï¼Œç”¨æˆ·è‡ªå·±æ— æ³•ä¿®æ”¹ã€‚å¯†ç ä¸€èˆ¬é•¿æœŸæœ‰æ•ˆï¼Œç”¨æˆ·ä¸ä¿®æ”¹ï¼Œå°±ä¸ä¼šå‘ç”Ÿå˜åŒ–ã€‚

2. ä»¤ç‰Œå¯ä»¥è¢«æ•°æ®æ‰€æœ‰è€…æ’¤é”€ï¼Œä¼šç«‹å³å¤±æ•ˆã€‚ä»¥ä¸Šä¾‹è€Œè¨€ï¼Œå±‹ä¸»å¯ä»¥éšæ—¶å–æ¶ˆå¿«é€’å‘˜çš„ä»¤ç‰Œã€‚å¯†ç ä¸€èˆ¬ä¸å…è®¸è¢«ä»–äººæ’¤é”€ã€‚

3. ä»¤ç‰Œæœ‰æƒé™èŒƒå›´ï¼ˆscopeï¼‰ï¼Œæ¯”å¦‚åªèƒ½è¿›å°åŒºçš„äºŒå·é—¨ã€‚å¯¹äºç½‘ç»œæœåŠ¡æ¥è¯´ï¼Œåªè¯»ä»¤ç‰Œå°±æ¯”è¯»å†™ä»¤ç‰Œæ›´å®‰å…¨ã€‚å¯†ç ä¸€èˆ¬æ˜¯å®Œæ•´æƒé™ã€‚



OAuthå¼•å…¥äº†ä¸€ä¸ªæˆæƒå±‚ï¼Œç”¨æ¥åˆ†ç¦»ä¸¤ç§ä¸åŒçš„è§’è‰²ï¼Œå®¢æˆ·ç«¯å’Œèµ„æºæ‰€æœ‰è€…ã€‚OAuth2.0è§„å®šäº†4ç§è·å¾—ä»¤ç‰Œçš„æµç¨‹ï¼Œå¯ä»¥é€‰æ‹©æœ€é€‚åˆè‡ªå·±çš„ä¸€ç§ï¼Œå‘ç¬¬ä¸‰æ–¹åº”ç”¨é¢å‘ä»¤ç‰Œã€‚ä¸ç®¡å“ªä¸€ç§æ–¹å¼ï¼Œç¬¬ä¸‰æ–¹åº”ç”¨å£°æƒ…ä»¤ç‰Œä¹‹å‰éƒ½éœ€è¦åˆ°ç³»ç»Ÿå¤‡æ¡ˆï¼Œè¯´æ˜è‡ªå·±çš„èº«ä»½ï¼Œç„¶åæ‹¿åˆ°ä¸¤ä¸ªèº«ä»½æ ‡è¯†ç ï¼šå®¢æˆ·ç«¯IDå’Œå®¢æˆ·ç«¯å¯†é’¥ã€‚

ğŸ¥‘æˆæƒç ï¼š

ç¬¬ä¸‰æ–¹åº”ç”¨å…ˆç”³è¯·ä¸€ä¸ªæˆæƒç ï¼Œç„¶åå†ç”¨è¿™ä¸ªç è·å–ä»¤ç‰Œã€‚

å®‰å…¨æ€§æœ€é«˜ï¼Œä¹Ÿæ˜¯æœ€å¸¸è§çš„æµç¨‹ï¼Œæˆæƒç ç”±å‰ç«¯ä¼ é€ï¼Œä»¤ç‰Œåˆ™å­˜å‚¨åœ¨åç«¯ï¼Œè€Œä¸”æ‰€æœ‰ä¸èµ„æºæœåŠ¡å™¨çš„é€šä¿¡éƒ½åœ¨åç«¯å®Œæˆï¼Œè¿™æ ·å‰åç«¯åˆ†ç¦»å¯ä»¥é¿å…ä»¤ç‰Œæ³„éœ²ã€‚

- éšè—å¼

- å¯†ç å¼

- å®¢æˆ·ç«¯å‡­è¯

  





# spring security

> SpringSecurityæ˜¯Springä¸‹çš„ä¸€ä¸ªå®‰å…¨æ¡†æ¶ï¼Œä¸shiro ç±»ä¼¼ï¼Œä¸€èˆ¬ç”¨äºç”¨æˆ·è®¤è¯ï¼ˆAuthenticationï¼‰å’Œç”¨æˆ·æˆæƒï¼ˆAuthorizationï¼‰ä¸¤ä¸ªéƒ¨åˆ†ï¼Œå¸¸ä¸ä¸SpringBootç›¸æ•´åˆã€‚



https://juejin.cn/post/6844903834402193415#heading-0 



<img src="D:\Typora\Vblogç ”ä¹ .assets\image-20220425112147886.png" alt="image-20220425112147886" style="zoom:67%;" />

### åŸç†

<img src="D:\Typora\Vblogç ”ä¹ .assets\image-20220425113813374.png" alt="image-20220425113813374" style="zoom:200%;" />



![image-20220425114334719](D:\Typora\è‡ªæœåŠ¡\ï½“ï½ï½’ï½‰ï½ï½‡ï½“ï½…ï½ƒï½•ï½’ï½‰ï½”ï½™.assets\image-20220425114334719.png)

> spring securityä¸­çš„åŠŸèƒ½æ˜¯ä¸€ç³»åˆ—è¿‡æ»¤å™¨æ¥å®ç°çš„ï¼Œé»˜è®¤æœ‰15ä¸ªï¼Œæ¯ä¸€ä¸ªè¿‡æ»¤å™¨éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„configureræ¥é…ç½®ï¼Œè¿™äº›configureéƒ½æœ‰ä¸€ä¸ªå…±åŒçˆ¶ç±»ï¼Œå°±æ˜¯SecurityConfigurer

```java 
//æœ€é¡¶å±‚çš„æ¥å£ï¼Œåªæœ‰ä¸¤ä¸ªæ–¹æ³•
public interface SecurityConfigurer<O, B extends SecurityBuilder<O>> {
    void init(B builder) throws Exception;

    void configure(B builder) throws Exception;
}
```





é‡è¦çš„å®ç°ç±»ï¼š**SecurityConfigureAdapter**ï¼Œé»˜è®¤çš„15ä¸ªè¿‡æ»¤å™¨çš„Configurerç±»éƒ½ç»§æ‰¿è‡ªå®ƒï¼Œ

è€Œå®ƒå¤šäº†ä¸€ä¸ªæ–¹æ³•ï¼špublic B and()ï¼Œ**è¿”å›ä¸€ä¸ªSecurityBuilderçš„å­ç±»ï¼Œå®é™…ä¸Šå°±æ˜¯HttpSecurityï¼Œå³andæ–¹æ³•æ€»æ˜¯è®©æˆ‘ä»¬å›åˆ°httpSecurityï¼Œä»è€Œå¼€å¯æ–°ä¸€è½®çš„xxxConfigurerçš„é…ç½®**

```java 
public abstract class SecurityConfigurerAdapter<O, B extends SecurityBuilder<O>>
		implements SecurityConfigurer<O, B> {

	public void init(B builder) throws Exception {
	}

	public void configure(B builder) throws Exception {
	}
	public B and() {
		return getBuilder();
	}

}

```

### æ ¸å¿ƒç»„ä»¶

ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªï¼š

**SecurityContextHolder**:        å­˜æ”¾èº«ä»½ä¿¡æ¯çš„å®¹å™¨

**Authentication**:  èº«ä»½ä¿¡æ¯çš„æŠ½è±¡æ¥å£

**AuthenticationManager**: èº«ä»½è®¤è¯å™¨ï¼Œè®¤è¯çš„æ ¸å¿ƒæ¥å£

**UserDetailsService**ï¼š ä¸€èˆ¬ç”¨äºä»æ•°æ®åº“ä¸­åŠ è½½èº«ä»½ä¿¡æ¯

**UserDetails**: ç›¸æ¯”Authenticationï¼Œæœ‰æ›´è¯¦ç»†çš„èº«ä»½ä¿¡æ¯




#### 1.1SecurityContextHolder

ç”¨äºå­˜å‚¨å®‰å…¨ä¸Šä¸‹æ–‡ï¼ˆsecurity contextï¼‰çš„ä¿¡æ¯ï¼Œä¿å­˜äº†å½“å‰ç”¨æˆ·ï¼Œè¯¥ç”¨æˆ·æ˜¯å¦å·²ç»è®¤è¯ï¼Œæ‹¥æœ‰é‚£äº›è§’è‰²æƒé™ç­‰ä¿¡æ¯

> é»˜è®¤ä½¿ç”¨ThreadLocalç­–ç•¥æ¥ä¿å­˜å­˜å‚¨è®¤è¯ä¿¡æ¯ï¼Œ çœ‹åˆ° `ThreadLocal` ä¹Ÿå°±æ„å‘³ç€ï¼Œè¿™æ˜¯ä¸€ç§ä¸çº¿ç¨‹ç»‘å®šçš„ç­–ç•¥ã€‚Spring Security åœ¨ç”¨æˆ·ç™»å½•æ—¶è‡ªåŠ¨ç»‘å®šè®¤è¯ä¿¡æ¯åˆ°å½“å‰çº¿ç¨‹ï¼Œåœ¨ç”¨æˆ·é€€å‡ºæ—¶ï¼Œè‡ªåŠ¨æ¸…é™¤å½“å‰çº¿ç¨‹çš„è®¤è¯ä¿¡æ¯ã€‚ä½†è¿™ä¸€åˆ‡çš„å‰æï¼Œæ˜¯ä½ åœ¨ web åœºæ™¯ä¸‹ä½¿ç”¨ Spring Securityï¼Œ 

è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼š

å› ä¸ºèº«ä»½ä¿¡æ¯å’Œçº¿ç¨‹æ˜¯ç»‘å®šçš„ï¼Œå¯ä»¥åœ¨ç¨‹åºçš„ä»»ä½•åœ°æ–¹ä½¿ç”¨é™æ€æ–¹æ³•è·å–ç”¨æˆ·ä¿¡æ¯

```java
Object principal = SecurityContextHolder.getContext().getAuthentication().getPrincipal() ;

if (principal instanceof UserDetails) {
String username = ((UserDetails)principal).getUsername();
} else {
String username = principal.toString();
}
```



#### 1.2Authenticationé¡¶çº§æ¥å£

spring securityä¸­çš„æœ€é«˜çº§åˆ«çš„èº«ä»½/è®¤è¯çš„æŠ½è±¡

```java
public interface Authentication extends Principal, Serializable {
    //æƒé™ä¿¡æ¯åˆ—è¡¨ï¼Œé»˜è®¤æ˜¯GrantedAuthorityæ¥å£çš„ä¸€äº›å®ç°ç±»ï¼Œé€šå¸¸æ˜¯ä»£è¡¨æƒä¿¡æ¯çš„ä¸€ç³»åˆ—å­—ç¬¦ä¸²
    Collection<? extends GrantedAuthority> getAuthorities();
//å¯†ç ä¿¡æ¯ï¼Œç”¨æˆ·è¾“å…¥çš„å¯†ç ä¸²ï¼Œè®¤è¯åå›è¢«ç§»é™¤ç”¨äºä¿éšœå®‰å…¨
    Object getCredentials();
//ç»†èŠ‚ä¿¡æ¯ï¼Œè®°å½•äº†è®¿é—®è€…çš„ipåœ°å€å’Œsessionidçš„å€¼
    Object getDetails();
//æœ€é‡è¦çš„èº«ä»½ä¿¡æ¯ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹è¿”å›çš„æ˜¯UserDetailsæ¥å£çš„å®ç°ç±»
    Object getPrincipal();

    boolean isAuthenticated();

    void setAuthenticated(boolean isAuthenticated) throws IllegalArgumentException;
}
```



*â­ï¼šspring securityæ˜¯å¦‚ä½•å®Œæˆèº«ä»½è®¤è¯çš„ï¼Ÿ*

1. è¿‡æ»¤å™¨è·å–ç”¨æˆ·åå’Œå¯†ç ï¼Œå°è£…æˆAuthenticationï¼Œé€šå¸¸æ˜¯ `UsernamePasswordAuthenticationToken`  è¿™ä¸ªå®ç°ç±»
2. AuthenticationManagerèº«ä»½ç®¡ç†å™¨ï¼ˆåˆ©ç”¨å®ƒçš„å®ç°ç±»ï¼‰è´Ÿè´£éªŒè¯è¿™ä¸ª`Authentication`
3. è®¤è¯å®Œæˆåï¼ŒAuthenticationManagerèº«ä»½ç®¡ç†å™¨è¿”å›ä¸€ä¸ªè¢«å¡«å……æ»¡äº†ä¿¡æ¯çš„`Authencation`å®ä¾‹
4. SecurityContextHolderå®‰å…¨ä¸Šä¸‹æ–‡å®¹å™¨å°†ç¬¬ä¸‰æ­¥å¡«å……äº†ä¿¡æ¯çš„Authencationå®ä¾‹é€šè¿‡ `SecurityContextHolder.getContext().setAuthentication(â€¦) `æ–¹æ³•ï¼Œè®¾ç½®åˆ°å…¶ä¸­ã€‚ 

#### 1.3AuthenticationManagerã€ProviderManagerã€AuthenticationProvider

 `AuthenticationManager`æ¥å£æ˜¯è®¤è¯ç›¸å…³çš„æ ¸å¿ƒæ¥å£ï¼Œä¹Ÿæ˜¯å‘èµ·è®¤è¯çš„å‡ºå‘ç‚¹ï¼Œå®ƒä¸€èˆ¬ä¸ç›´æ¥è®¤è¯ï¼ŒAuthenticationManageræ¥å£çš„å®ç°ç±»`ProviderManager`å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ª`List<AuthenticationProvider>`åˆ—è¡¨ï¼Œå­˜æ”¾äº†å¤šç§è®¤è¯æ–¹å¼ï¼Œå®é™…ä¸Šè¿™æ˜¯å§”æ‰˜è€…æ¨¡å¼çš„åº”ç”¨ï¼ˆDelegateï¼‰ï¼Œä¸åŒçš„è®¤è¯æ–¹æ³•ï¼ˆå¦‚å¯†ç +ç”¨æˆ·åï¼Œé‚®ç®±+ç”¨æˆ·åï¼‰å¯¹åº”ä¸åŒçš„ `AuthenticationProvider `ï¼Œåªéœ€è¦é€šè¿‡ä¸€ä¸ªAuthenticationprovideråˆ™è®¤ä¸ºç™»å½•æˆåŠŸ 

æºç ï¼š

```java
public class ProviderManager implements AuthenticationManager, MessageSourceAware, InitializingBean {

	 private List<AuthenticationProvider> providers;
    
    
    //è®¤è¯å…³é”®æ–¹æ³• 
      public Authentication authenticate(Authentication authentication) throws AuthenticationException {
        Iterator var8 = this.getProviders().iterator();

          //æ‹¿åˆ°List<AuthenticationProvider> 
        while(var8.hasNext()) {
            AuthenticationProvider provider = (AuthenticationProvider)var8.next();
                try {
                    result = provider.authenticate(authentication);
                    if (result != null) {
                        this.copyDetails(authentication, result);
                        break;
                    }
                } catch (InternalAuthenticationServiceException | AccountStatusException var13) {
                  ...
                } 
            }
        }
        if (result != null) {
            //ç§»é™¤å¯†ç  
            if (this.eraseCredentialsAfterAuthentication && result instanceof CredentialsContainer) {
                ((CredentialsContainer)result).eraseCredentials();
            }
           //å‘å¸ƒç™»å½•æˆåŠŸäº‹ä»¶
            if (parentResult == null) {
                this.eventPublisher.publishAuthenticationSuccess(result);
            }
            return result;
        } else {
            if (lastException == null) {
                lastException = new ProviderNotFoundException(this.messages.getMessage("ProviderManager.providerNotFound", new Object[]{toTest.getName()}, "No AuthenticationProvider found for {0}"));
            }
// å¦‚æœæ²¡æœ‰è®¤è¯æˆåŠŸï¼Œå‘å¸ƒç™»å½•å¼‚å¸¸ä¿¡æ¯
            if (parentException == null) {
                this.prepareException((AuthenticationException)lastException, authentication);
            }

            throw lastException;
        }
    }

}
```



#### 1.4AuthenticationManagerBuilder:ç”¨æ¥æ„å»ºAuthenticationManager





 ![æ¶æ„æ¦‚è§ˆå›¾](https://kirito.iocoder.cn/spring%20security%20architecture.png) 

## å®éªŒ

### 1.å¼•å…¥spring security

â‘ ã€å¯¼å…¥ä¾èµ–ï¼š

```xml 
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-security</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.security</groupId>
    <artifactId>spring-security-test</artifactId>
    <scope>test</scope>
</dependency>
```

â‘¡ã€ç¼–å†™controller

```java 
@Controller
public class UserContorller {
    @GetMapping("/hello")
    @ResponseBody
    public  String hello(){
        return "hello controller" ;
    }
}

```

â‘¢ã€è®¿é—®helloé¡µé¢ï¼Œéœ€è¦å…ˆç™»å½•ï¼Œç”¨æˆ·åé»˜è®¤ä¸ºuserï¼Œå¯†ç å°†æ‰“å°åœ¨æ§åˆ¶å°ä¸­ï¼Œå®é™…ä¸Šæ˜¯éšæœºç”Ÿæˆçš„uuid

**æºç **

- å¯¼å…¥securityä¾èµ–åï¼Œé»˜è®¤è®¿é—®çš„è·¯å¾„å°†ç»è¿‡è¯¥è¿‡æ»¤å™¨ï¼Œå¹¶è®¿é—®å…¶æ— å‚æ„é€ ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„postæ–¹å¼ç™»å½•ï¼Œè·¯å¾„ä¸º/login
- è¿›å…¥é»˜è®¤ç™»å½•é¡µï¼Œé€šè¿‡HttpServletRequestå¯¹è±¡è·å–åˆ°ç™»å½•è¡¨å•çš„ç”¨æˆ·åå’Œå¯†ç 
- åˆ›å»ºä¸€ä¸ªç”¨æˆ·åå’Œå¯†ç çš„ä»¤ç‰Œå¯¹è±¡
- å¤„ç†è¡¨å•çš„ä¿¡æ¯

æºç 

```java 
// UsernamePasswordAuthenticationFilter.java)
public class UsernamePasswordAuthenticationFilter extends AbstractAuthenticationProcessingFilter {
    public static final String SPRING_SECURITY_FORM_USERNAME_KEY = "username";
    public static final String SPRING_SECURITY_FORM_PASSWORD_KEY = "password";
    
    //ä»¥ä¸åŒºåˆ†å¤§å°å†™çš„postæ–¹å¼å’Œhttpæ–¹æ³•åˆ›å»ºè·¯å¾„åŒ¹é…å™¨
    private static final AntPathRequestMatcher DEFAULT_ANT_PATH_REQUEST_MATCHER = new AntPathRequestMatcher("/login", "POST");
    private String usernameParameter = "username";
    private String passwordParameter = "password";
    private boolean postOnly = true;

    public Authentication attemptAuthentication(HttpServletRequest request, HttpServletResponse response) throws AuthenticationException {
     else {
         // ä»requestä¸­è·å–ç”¨æˆ·åå’Œå¯†ç 
            String username = this.obtainUsername(request);
            username = username != null ? username : "";
            username = username.trim();
            String password = this.obtainPassword(request);
            password = password != null ? password : "";
           //ç”Ÿæˆä¸€ä¸ªç”¨æˆ·åå’Œå¯†ç èº«ä»½éªŒè¯çš„ä»¤ç‰Œ UsernamePasswordAuthenticationToken authRequest = new UsernamePasswordAuthenticationToken(username, password);
         //è®¾ç½®èº«ä»½è¯·æ±‚çš„è®¤è¯ä¿¡æ¯
        this.setDetails(request, authRequest);
         //è¿”å›ä¸€ä¸ªç»è¿‡èº«ä»½éªŒè¯çš„å¯¹è±¡
            return this.getAuthenticationManager().authenticate(authRequest);
        }
    }
```



### 2.é…ç½®&è‡ªå®šä¹‰ç”¨æˆ·

åœºæ™¯ï¼š 

**â‘ ã€è‡ªå®šä¹‰ç™»å½•æ¥å£ï¼šå®ç°UserDetailsServiceæ¥å£ï¼Œé‡å†™æ–¹æ³•ï¼Œè‡ªå®šä¹‰ç™»å½•è§„åˆ™ã€‚**

![image-20220109100649495](D:\Typora\è‡ªæœåŠ¡\ï½“ï½ï½’ï½‰ï½ï½‡ï½“ï½…ï½ƒï½•ï½’ï½‰ï½”ï½™.assets\image-20220109100649495.png)

è¿”å›å€¼æ˜¯ä¸€ä¸ª`UserDetails`ä¹Ÿæ˜¯ä¸€ä¸ªæ¥å£

```Java 
public interface UserDetails extends Serializable {
    //è·å–æ‰€æœ‰æƒé™
    Collection<? extends GrantedAuthority> getAuthorities();
    String getPassword();
    String getUsername();
    // ä¸‹é¢ä¸‰ä¸ªé»˜è®¤æ˜¯falseï¼Œè¡¨ç¤ºè¿‡æœŸäº†ï¼Œé”å®šäº†ï¼Œä¸å¯ç”¨ï¼Œè¦å¯ç”¨è¿™ä¸ªç”¨æˆ·ï¼Œå°±è¦è®¾ç½®æˆtureï¼Œè‚¯å®šã€‚
//è´¦å·æ˜¯å¦æ²¡æœ‰è¿‡æœŸ
    boolean isAccountNonExpired();
//è´¦å·æ˜¯å¦æ²¡æœ‰é”å®š
    boolean isAccountNonLocked();
//å¯†ç ï¼ˆå‡­è¯ï¼‰æ˜¯å¦æ²¡æœ‰è¿‡æœŸ 
    boolean isCredentialsNonExpired();
//æ˜¯å¦å¯ç”¨
    boolean isEnabled();
}

```

spring Securityæœ‰é»˜è®¤çš„userdetailså®ç° `org.springframework.security.core.userdetails.User`

![image-20220109101019272](D:\Typora\è‡ªæœåŠ¡\ï½“ï½ï½’ï½‰ï½ï½‡ï½“ï½…ï½ƒï½•ï½’ï½‰ï½”ï½™.assets\image-20220109101019272.png)



```java 
@Component
public class MyUserDetailsService implements UserDetailsService {
    private  static final Logger logger = LoggerFactory.getLogger(UserDetailsService.class) ;

    /**
     * è®¾ç½®ç™»å½•çš„ç”¨æˆ·åä¸ºä»»æ„ï¼Œå¯†ç ä¸º123
     * @param username ç”¨æˆ·å
     * @return æ ¸å¿ƒç”¨æˆ·ä¿¡æ¯ï¼Œä¸€ä¸ªå®Œå…¨å¡«å……çš„ç”¨æˆ·è®°å½•
     * @throws UsernameNotFoundException
     */
    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        logger.info("ç™»å½•,ç”¨æˆ·ï¼š{}",username) ;
        return new User(username,"123", AuthorityUtils.commaSeparatedStringToAuthorityList("admin"));
    }
}

```



â‘¡ã€é…ç½®ç™»å½•æ‹¦æˆªï¼Œç»§æ‰¿WebSecurityConfigurerAdapteré…ç½®ç±»ï¼Œé‡å†™configureæ–¹æ³•

```java 
@Configuration
public class MySecurityConfig extends WebSecurityConfigurerAdapter {
    @Override
    protected void configure(HttpSecurity http) throws Exception {
//        super.configure(http);
        http.httpBasic()           //httpBasicæ–¹å¼çš„é…ç½®
                .and()//ç›¸å½“äºé…ç½®å¦å¤–ä¸€ä¸ªconfigurer
                .authorizeHttpRequests()
                .anyRequest() //å¯¹äºæ‰€æœ‰è¯·æ±‚
                .authenticated(); //éƒ½éœ€è¦è®¤è¯
    }
}
```

WebSecurityConfigurerAdapterä¸­æœ‰3ä¸ªconfigureæ–¹æ³•ï¼š

| æ–¹æ³•                                    | æè¿°                          |
| --------------------------------------- | ----------------------------- |
| configure(WebSecurity)                  | é…ç½®spring securityçš„filteré“¾ |
| configure(HttpSecurity)                 | é…ç½®å¦‚ä½•é€šè¿‡æ‹¦æˆªå™¨ä¿æŠ¤è¯·æ±‚    |
| configure(AuthenticationManagerBuilder) | é…ç½®user-detailæœåŠ¡           |

AuthenticationManagerBuilderä¸­çš„3ä¸ªå…³é”®æ–¹æ³•å®šä¹‰äº†ä»ä½•å¤„æ‹¿åˆ°userä¿¡æ¯

```java 
  //å®šä¹‰åœ¨å†…å­˜ä¸­æ‹¿
public InMemoryUserDetailsManagerConfigurer<AuthenticationManagerBuilder> inMemoryAuthentication() throws Exception {
        return (InMemoryUserDetailsManagerConfigurer)this.apply(new InMemoryUserDetailsManagerConfigurer());
    }
//å­˜å‚¨åœ¨æ•°æ®åº“ï¼Œç”¨JDBCçš„æ–¹å¼æ‹¿
    public JdbcUserDetailsManagerConfigurer<AuthenticationManagerBuilder> jdbcAuthentication() throws Exception {
        return (JdbcUserDetailsManagerConfigurer)this.apply(new JdbcUserDetailsManagerConfigurer());
    }
//è‡ªå®šä¹‰ç”¨æˆ·å­˜å‚¨çš„å®ç°ï¼Œä¸é™äºjdbcæ–¹å¼ï¼Œå¯ä»¥ä½¿ç”¨å…¶ä»–æ¡†æ¶ 
    public <T extends UserDetailsService> DaoAuthenticationConfigurer<AuthenticationManagerBuilder, T> userDetailsService(T userDetailsService) throws Exception {
        this.defaultUserDetailsService = userDetailsService;
        return (DaoAuthenticationConfigurer)this.apply(new DaoAuthenticationConfigurer(userDetailsService));
    }
```

https://blog.csdn.net/itguangit/article/details/78924032



### 3.è‡ªå®šä¹‰ç™»å½•é¡µé¢

*â‘ ã€ç¼–å†™è‡ªå®šä¹‰ç™»å½•é¡µé¢å’Œé¦–é¡µ*

**ç™»å½•æ¥å£ï¼šæŒ‡çš„æ˜¯æäº¤ç™»å½•æ•°æ®çš„åœ°æ–¹ï¼Œå³ç™»é™†é¡µé¢çš„formè¡¨å•çš„actionå±æ€§å¯¹åº”çš„å€¼**

åœ¨spring securityä¸­ï¼Œé»˜è®¤çš„ç™»é™†é¡µé¢å’Œç™»å½•æ¥å£éƒ½æ˜¯/login 

- ç™»å½•å‚æ•°æ˜¯usernameå’Œpasswordï¼Œé»˜è®¤æƒ…å†µä¸‹ä¸èƒ½æ”¹å˜ï¼Œæˆ–åœ¨é…ç½®ä¸­æŒ‡å®š

```html 
ç™»å½•é¡µï¼š 
<body>
    <h2>è¯·ç™»å½•</h2>
    <form action="/auth/login" method="post">
        ç”¨æˆ·åï¼š<input name="username" type="text" placeholder="ç”¨æˆ·å"><br/>
        å¯†ç ï¼š<input name="password" type="password" placeholder="å¯†ç "><br/>
        <input type="submit" value="ç™»å½•">
    </form>
</body>
```

*â‘¡ã€ç¼–å†™æ§åˆ¶å™¨ï¼š*

```java 
   @GetMapping("/login")
    public String login(){
        return "login" ;
    }

    @GetMapping("index")
    public String index() {
        return "index" ;
    }
```

*â‘¢ã€ç¼–å†™é…ç½®*

```java
@Configuration
public class MySecurityConfig extends WebSecurityConfigurerAdapter {
    @Override
    protected void configure(HttpSecurity http) throws Exception {
            http.csrf().disable()
                    .formLogin() // å¼€å¯è¡¨å•è®¤è¯
                    .loginPage("/login") //é…ç½®ç™»å½•é¡µ
                    .loginProcessingUrl("/auth/login")  // ç™»å½•è¡¨å•æäº¤åœ°å€
                    .and()
                    .authorizeRequests() // èº«ä»½è®¤è¯è¯·æ±‚
                    .antMatchers("/login").permitAll() // urlè·¯å¾„åŒ¹é…ä¸ºloginçš„ï¼Œå…è®¸æ‰€æœ‰ç”¨æˆ·è®¿é—®
                    .anyRequest() //å…¶ä»–çš„æ‰€æœ‰è¯·æ±‚ 
                    .authenticated(); //éƒ½éœ€è¦è®¤è¯
    }
}

```

loginProcessingUrl("/auth/login") ä¸­å®šä¹‰äº†è¡¨å•æäº¤åœ°å€ï¼Œä½†controllerä¸­æ²¡æœ‰å¯¹åº”è·¯å¾„çš„æ–¹æ³•ï¼Œspring securityé»˜è®¤æ‹¦æˆªæ‰€æœ‰è¦æ±‚ï¼Œåˆé‡å®šå‘å›/loginç™»å½•é¡µã€‚ 

### 4.è‡ªå®šä¹‰ç™»å½•çŠ¶æ€

è‡ªå®šä¹‰ç™»å½•æˆåŠŸå’Œå¤±è´¥çš„ç±»ï¼š

```java 
@Component
@Slf4j
public class MyAuthenticationFailureHandler implements AuthenticationFailureHandler {
    @Autowired
    ObjectMapper objectMapper;

    @Override
    public void onAuthenticationFailure(HttpServletRequest request, HttpServletResponse response, AuthenticationException exception) throws IOException, ServletException {
        log.info("ç™»å½•å¤±è´¥");

        response.setContentType("application/json;charset=utf-8");
        PrintWriter writer = response.getWriter();
        writer.write(new ObjectMapper().writeValueAsString(exception));
        writer.flush();
        writer.close();
//        response.setStatus(200);
//        response.getWriter().write(objectMapper.writeValueAsString(exception));
    }
}

```

å¤±è´¥ï¼š

```Java
@Component
@Slf4j
public class MyAuthenticationFailureHandler implements AuthenticationFailureHandler {
    @Autowired
    ObjectMapper objectMapper;

    @Override
    public void onAuthenticationFailure(HttpServletRequest request, HttpServletResponse response, AuthenticationException exception) throws IOException, ServletException {
        log.info("ç™»å½•å¤±è´¥");
        response.setContentType("application/json;charset=utf-8");
        PrintWriter writer = response.getWriter();
        writer.write(new ObjectMapper().writeValueAsString(exception));
        writer.flush();
        writer.close();
//        response.setStatus(200);
//        response.getWriter().write(objectMapper.writeValueAsString(exception));
    }
}

```

â‘¡ã€ä¿®æ”¹é…ç½®ï¼š

```java 
@Configuration
public class MySecurityConfig extends WebSecurityConfigurerAdapter {
    @Autowired
    MyAuthenticationSuccessHandler myAuthenticationSuccessHandler;
    @Autowired
    MyAuthenticationFailureHandler myAuthenticationFailureHandler;
    @Override
    protected void configure(HttpSecurity http) throws Exception {
            http.csrf().disable()
                    .formLogin()
                    .loginPage("/login")
                    .loginProcessingUrl("/auth/login")
                    .successHandler(myAuthenticationSuccessHandler)
                    .failureHandler(myAuthenticationFailureHandler)
                    .and()
                    .authorizeRequests()
                    .antMatchers("/login").permitAll()
                    .anyRequest()
                    .authenticated();
    }
}
```

â‘¢ã€è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œ

```java 
    @GetMapping("/info")
    @ResponseBody
    public Object getCurrentUser(Authentication authentication) {
        return authentication;
    }
```

### 5.è‡ªå®šä¹‰è§’è‰²å’Œæƒé™

åœ¨spring securityä¸­ï¼Œåªæœ‰æƒé™æ²¡æœ‰è§’è‰²ï¼Œæ‰€è°“è§’è‰²å°±æ˜¯åœ¨æƒé™å‰é¢åŠ å‰ç¼€`ROLE_`ï¼Œç„¶åæ”¾åˆ°æƒé™ä¸­

åˆ¤æ–­è§’è‰²æ—¶ï¼Œ.hasRole("ADMIN")å‰ä¸éœ€è¦åŠ _ROLE

https://www.malaoshi.top/show_1EF60RQYLTKO.html

è¸©å‘ï¼š

https://www.coder.work/article/55112

## è·å–ç”¨æˆ·ä¿¡æ¯

https://stackoverflow.com/questions/4989063/what-is-the-meaning-and-difference-between-subject-user-and-principal

https://stackoverflow.com/questions/37499307/whats-the-principal-in-spring-security

https://developer.51cto.com/article/664525.html



https://www.cnblogs.com/LQBlog/p/14236535.html



**Principal**